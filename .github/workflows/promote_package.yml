name: Promote Python Package

on:
  workflow_run:
    workflows: ["Publish Python Package"]  # Match this with actual publish workflow name
    types:
      - completed
    branches:
      - main

env:
  CLOUDSMITH_NAMESPACE: ${{ vars.CLOUDSMITH_NAMESPACE }}
  CLOUDSMITH_REPOSITORY_SRC: ${{ vars.CLOUDSMITH_REPOSITORY_SRC }}
  CLOUDSMITH_REPOSITORY_DEST: ${{ vars.CLOUDSMITH_REPOSITORY_DEST }}
  CLOUDSMITH_SERVICE_SLUG: ${{ vars.CLOUDSMITH_SERVICE_SLUG }}
  PACKAGE_NAME: ${{ vars.PACKAGE_NAME }}
  PACKAGE_VERSION: ${{ vars.PACKAGE_VERSION }}

permissions:
  id-token: write
  contents: read

jobs:
  promote:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug Cloudsmith Vars
        run: |
          echo "Namespace: $CLOUDSMITH_NAMESPACE"
          echo "Repo Src: $CLOUDSMITH_REPOSITORY_SRC"
          echo "Repo Dest: $CLOUDSMITH_REPOSITORY_DEST"
          echo "Package: $PACKAGE_NAME"
          echo "Version: $PACKAGE_VERSION"

      - name: Get OIDC Token
        run: |
          echo "Requesting GitHub OIDC token..."
          oidc_token=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://AzureADTokenExchange" | jq -r '.value')

          echo "Exchanging token with Cloudsmith..."
          cloudsmith_token=$(curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"oidc_token\":\"$oidc_token\", \"service_slug\":\"${{ env.CLOUDSMITH_SERVICE_SLUG }}\"}" \
            "https://api.cloudsmith.io/openid/${{ env.CLOUDSMITH_NAMESPACE }}/" | jq -r '.token')

          if [ -z "$cloudsmith_token" ]; then
            echo "âŒ Failed to retrieve Cloudsmith token"
            exit 1
          fi

          echo "::add-mask::$cloudsmith_token"
          echo "CLOUDSMITH_API_KEY=$cloudsmith_token" >> $GITHUB_ENV

      - name: Promote package
        run: |
          echo "Promoting $PACKAGE_NAME-$PACKAGE_VERSION from $CLOUDSMITH_REPOSITORY_SRC to $CLOUDSMITH_REPOSITORY_DEST"

          curl -X POST "https://api.cloudsmith.io/v1/packages/${CLOUDSMITH_NAMESPACE}/${CLOUDSMITH_REPOSITORY_SRC}/${PACKAGE_NAME}/${PACKAGE_VERSION}/move/" \
            -H "Authorization: Bearer $CLOUDSMITH_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{ \"destination_repo\": \"$CLOUDSMITH_REPOSITORY_DEST\" }"
